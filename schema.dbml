// ConstructSync Database Schema
// Generated from migration.sql

// Auth & Users
Table companies {
  id uuid [pk, default: `gen_random_uuid()`]
  name varchar(255) [not null]
  email varchar(255)
  phone varchar(50)
  address text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table users {
  id uuid [pk, default: `gen_random_uuid()`]
  company_id uuid [not null, ref: > companies.id]
  email varchar(255) [unique, not null]
  password_hash varchar(255) [not null]
  first_name varchar(100)
  last_name varchar(100)
  role varchar(50) [not null]
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table sessions {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [not null, ref: > users.id]
  token varchar(500) [unique, not null]
  expires_at timestamp [not null]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table refresh_tokens {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [not null, ref: > users.id]
  token varchar(500) [unique, not null]
  expires_at timestamp [not null]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table device_tokens {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [not null, ref: > users.id]
  device_id varchar(255) [not null]
  token varchar(500) [not null]
  platform varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Company / Organization
Table company_settings {
  id uuid [pk, default: `gen_random_uuid()`]
  company_id uuid [unique, not null, ref: > companies.id]
  settings jsonb [default: '{}']
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Teams
Table teams {
  id uuid [pk, default: `gen_random_uuid()`]
  company_id uuid [not null, ref: > companies.id]
  name varchar(255) [not null]
  description text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table team_members {
  id uuid [pk, default: `gen_random_uuid()`]
  team_id uuid [not null, ref: > teams.id]
  user_id uuid [not null, ref: > users.id]
  role varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  
  indexes {
    (team_id, user_id) [unique]
  }
}

// Sites / Locations
Table sites {
  id uuid [pk, default: `gen_random_uuid()`]
  company_id uuid [not null, ref: > companies.id]
  name varchar(255) [not null]
  address text
  latitude decimal(10,8)
  longitude decimal(11,8)
  status varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table site_media {
  id uuid [pk, default: `gen_random_uuid()`]
  site_id uuid [not null, ref: > sites.id]
  uploaded_by uuid [ref: > users.id]
  media_type varchar(50)
  media_url text [not null]
  thumbnail_url text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table site_memos {
  id uuid [pk, default: `gen_random_uuid()`]
  site_id uuid [not null, ref: > sites.id]
  created_by uuid [ref: > users.id]
  title varchar(255)
  content text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table site_zones {
  id uuid [pk, default: `gen_random_uuid()`]
  site_id uuid [not null, ref: > sites.id]
  name varchar(255) [not null]
  description text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Jobs / Projects
Table jobs {
  id uuid [pk, default: `gen_random_uuid()`]
  company_id uuid [not null, ref: > companies.id]
  site_id uuid [ref: > sites.id]
  job_number varchar(100)
  name varchar(255) [not null]
  description text
  status varchar(50)
  start_date date
  end_date date
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table job_blocks {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [not null, ref: > jobs.id]
  name varchar(255) [not null]
  description text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table job_units {
  id uuid [pk, default: `gen_random_uuid()`]
  job_block_id uuid [ref: > job_blocks.id]
  job_id uuid [not null, ref: > jobs.id]
  unit_number varchar(100)
  description text
  status varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table job_tasks {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [not null, ref: > jobs.id]
  job_unit_id uuid [ref: > job_units.id]
  assigned_to uuid [ref: > users.id]
  title varchar(255) [not null]
  description text
  status varchar(50)
  priority varchar(50)
  due_date date
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table job_photos {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [not null, ref: > jobs.id]
  uploaded_by uuid [ref: > users.id]
  photo_url text [not null]
  thumbnail_url text
  caption text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table job_documents {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [not null, ref: > jobs.id]
  uploaded_by uuid [ref: > users.id]
  document_name varchar(255) [not null]
  document_url text [not null]
  document_type varchar(100)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table job_issues {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [not null, ref: > jobs.id]
  reported_by uuid [ref: > users.id]
  title varchar(255) [not null]
  description text
  status varchar(50)
  priority varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table job_variations {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [not null, ref: > jobs.id]
  created_by uuid [ref: > users.id]
  variation_number varchar(100)
  description text
  amount decimal(15,2)
  status varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table job_diary_entries {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [not null, ref: > jobs.id]
  created_by uuid [ref: > users.id]
  entry_date date [not null]
  content text
  weather varchar(100)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table progress_milestones {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [not null, ref: > jobs.id]
  name varchar(255) [not null]
  description text
  target_date date
  completion_date date
  status varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Time Tracking & Attendance
Table time_entries {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [not null, ref: > users.id]
  job_id uuid [ref: > jobs.id]
  clock_in timestamp [not null]
  clock_out timestamp
  total_hours decimal(5,2)
  notes text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table worker_locations {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [not null, ref: > users.id]
  latitude decimal(10,8) [not null]
  longitude decimal(11,8) [not null]
  recorded_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Materials & Inventory
Table materials {
  id uuid [pk, default: `gen_random_uuid()`]
  company_id uuid [not null, ref: > companies.id]
  name varchar(255) [not null]
  description text
  unit varchar(50)
  unit_price decimal(15,2)
  stock_quantity decimal(15,2) [default: 0]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table material_requests {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [not null, ref: > jobs.id]
  requested_by uuid [ref: > users.id]
  material_id uuid [not null, ref: > materials.id]
  quantity decimal(15,2) [not null]
  status varchar(50)
  requested_date date
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table material_usage {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [not null, ref: > jobs.id]
  material_id uuid [not null, ref: > materials.id]
  recorded_by uuid [ref: > users.id]
  quantity_used decimal(15,2) [not null]
  usage_date date
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table stock_adjustments {
  id uuid [pk, default: `gen_random_uuid()`]
  material_id uuid [not null, ref: > materials.id]
  adjusted_by uuid [ref: > users.id]
  adjustment_type varchar(50)
  quantity_change decimal(15,2) [not null]
  reason text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Contracts & Payments
Table subcontractor_contracts {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [not null, ref: > jobs.id]
  subcontractor_name varchar(255) [not null]
  contact_email varchar(255)
  contact_phone varchar(50)
  contract_value decimal(15,2)
  start_date date
  end_date date
  status varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table contract_payments {
  id uuid [pk, default: `gen_random_uuid()`]
  contract_id uuid [not null, ref: > subcontractor_contracts.id]
  amount decimal(15,2) [not null]
  payment_date date
  payment_method varchar(100)
  reference_number varchar(255)
  notes text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Notifications
Table notifications {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [not null, ref: > users.id]
  title varchar(255) [not null]
  message text
  notification_type varchar(50)
  is_read boolean [default: false]
  related_entity_type varchar(100)
  related_entity_id uuid
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table notification_preferences {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [unique, not null, ref: > users.id]
  email_notifications boolean [default: true]
  push_notifications boolean [default: true]
  sms_notifications boolean [default: false]
  preferences jsonb [default: '{}']
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Safety Management
Table safety_incidents {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [ref: > jobs.id]
  site_id uuid [ref: > sites.id]
  reported_by uuid [ref: > users.id]
  incident_date timestamp [not null]
  description text [not null]
  severity varchar(50)
  status varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table near_miss_reports {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [ref: > jobs.id]
  site_id uuid [ref: > sites.id]
  reported_by uuid [ref: > users.id]
  incident_date timestamp [not null]
  description text [not null]
  potential_severity varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table safety_inspections {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [ref: > jobs.id]
  site_id uuid [ref: > sites.id]
  inspected_by uuid [ref: > users.id]
  inspection_date date [not null]
  inspection_type varchar(100)
  findings text
  status varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table hazard_reports {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [ref: > jobs.id]
  site_id uuid [ref: > sites.id]
  reported_by uuid [ref: > users.id]
  hazard_type varchar(100)
  description text [not null]
  severity varchar(50)
  status varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table safety_training_records {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [not null, ref: > users.id]
  training_type varchar(255) [not null]
  training_date date [not null]
  expiry_date date
  certificate_url text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// File Upload System
Table media_uploads {
  id uuid [pk, default: `gen_random_uuid()`]
  uploaded_by uuid [ref: > users.id]
  file_name varchar(255) [not null]
  file_url text [not null]
  file_type varchar(100)
  file_size bigint
  related_entity_type varchar(100)
  related_entity_id uuid
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table document_folders {
  id uuid [pk, default: `gen_random_uuid()`]
  company_id uuid [not null, ref: > companies.id]
  parent_folder_id uuid [ref: > document_folders.id]
  name varchar(255) [not null]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table construction_documents {
  id uuid [pk, default: `gen_random_uuid()`]
  folder_id uuid [ref: > document_folders.id]
  job_id uuid [ref: > jobs.id]
  uploaded_by uuid [ref: > users.id]
  document_name varchar(255) [not null]
  document_url text [not null]
  document_type varchar(100)
  version varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Reporting / AI / Intelligence
Table document_chunks {
  id uuid [pk, default: `gen_random_uuid()`]
  document_id uuid [ref: > construction_documents.id]
  chunk_text text [not null]
  chunk_index integer
  embedding vector(1536)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table ai_query_history {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [ref: > users.id]
  query_text text [not null]
  response_text text
  context_used text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table chat_conversations {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [not null, ref: > users.id]
  title varchar(255)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table chat_messages {
  id uuid [pk, default: `gen_random_uuid()`]
  conversation_id uuid [not null, ref: > chat_conversations.id]
  sender_type varchar(50) [not null]
  message_text text [not null]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Financials / Budgets
Table job_budgets {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [unique, not null, ref: > jobs.id]
  total_budget decimal(15,2) [not null]
  allocated_budget decimal(15,2) [default: 0]
  spent_budget decimal(15,2) [default: 0]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table budget_line_items {
  id uuid [pk, default: `gen_random_uuid()`]
  job_budget_id uuid [not null, ref: > job_budgets.id]
  category varchar(255) [not null]
  description text
  allocated_amount decimal(15,2) [not null]
  spent_amount decimal(15,2) [default: 0]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table cost_transactions {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [not null, ref: > jobs.id]
  budget_line_item_id uuid [ref: > budget_line_items.id]
  transaction_type varchar(50)
  amount decimal(15,2) [not null]
  description text
  transaction_date date
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table job_revenue {
  id uuid [pk, default: `gen_random_uuid()`]
  job_id uuid [not null, ref: > jobs.id]
  revenue_type varchar(100)
  amount decimal(15,2) [not null]
  description text
  revenue_date date
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// System
Table audit_logs {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [ref: > users.id]
  action varchar(255) [not null]
  entity_type varchar(100)
  entity_id uuid
  old_values jsonb
  new_values jsonb
  ip_address varchar(50)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

Table system_settings {
  id uuid [pk, default: `gen_random_uuid()`]
  setting_key varchar(255) [unique, not null]
  setting_value text
  description text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

